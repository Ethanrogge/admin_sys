#cloud-config
autoinstall:
  version: 1
  locale: en_US.UTF-8
  keyboard:
    layout: us
    variant: ''
    toggle: null
  timezone: Europe/Paris

  user-data:
    users:
      - name: sysadmin
        gecos: System Administrator
        groups: [root,sudo,adm,systemd-journal,users]
        shell: /bin/bash
        sudo: ALL=(ALL) NOPASSWD:ALL
        lock_passwd: false
        plain_text_passwd: "admin"
        ssh_authorized_keys:
          - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDgcFFrEry9Mxc6mNAfd0EQdI2gLpDcxN4cc5rFM834NQm1cDZneibGEO1Z84h7UoKfMCYrwr2KVA9++TwXNvP1E2I62Ej/twU7nRZ9vG+84X7yKLrywjGQKTBJFE+vJVonIPg1jr4E9W+NScRE1CHlHtYsxIsJ>
      - name: secretary
        gecos: Secretary
        groups: [www-data,input,video,audio,users]
        shell: /bin/bash
        lock_passwd: false
        passwd: "*"

#  apt:
#    preserve_sources_list: false
#    mirror-selection:
#      primary:
#        - arches: [amd64]
#          uri: http://192.168.0.58/ubuntu
#  packages:
#    - git
#    - build-essential
#    - python3-pip

  late-commands:
    - curtin in-target --target=/target -- rm -f /etc/apt/sources.list.d/*.sources
    - curtin in-target --target=/target -- wget -O /etc/apt/trusted.gpg.d/aptly.gpg http://192.168.129.84/aptly.gpg
    - curtin in-target --target=/target -- wget -O /etc/apt/sources.list.d/ubuntu.sources http://192.168.129.84/profiles/sec/custom-aptly.sources
    - curtin in-target --target=/target -- bash -c 'echo "#deb [trusted=yes] http://192.168.129.84/ubuntu plucky main" > /etc/apt/sources.list'
    - curtin in-target --target=/target -- apt update
    - curtin in-target --target=/target -- apt remove -y openssh-client
    - curtin in-target --target=/target -- apt install -y sec-profile unattended-upgrades
    #- curtin in-target --target=/target -- bash -c 'echo "devuser ALL=(ALL) !/bin/bash, !/bin/sh, !/usr/bin/sudo, !/usr/bin/su" > /etc/sudoers.d/devuser'
    #- curtin in-target --target=/target -- chmod 440 /etc/sudoers.d/devuser
    #permet la mis Ã  jour auto sur le client
    - curtin in-target --target=/target -- bash -c 'echo "APT::Periodic::Update-Package-Lists \"1\";" > /etc/apt/apt.conf.d/20auto-upgrades && echo "APT::Periodic::Unattended-Upgrade \"1\";" >> /etc/apt/apt.c>    - curtin in-target --target=/target -- wget -O /etc/systemd/system/rc-local.service http://192.168.129.84/rc-client/rc-local.service
    - curtin in-target --target=/target -- wget -O /etc/rc.local http://192.168.129.84/rc-client/rc.local
    - curtin in-target --target=/target -- chmod +x /etc/rc.local
    - curtin in-target --target=/target -- systemctl enable rc-local
    - curtin in-target --target=/target -- sed -i 's/nullok_secure/nullok/' /etc/pam.d/common-auth

  shutdown: reboot